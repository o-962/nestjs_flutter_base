<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test</title>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
  <h1>WebSocket Test</h1>
  <div id="status">Connecting...</div>
  <button onclick="sendMessage()">Send Test Message</button>
  <div id="messages"></div>
  <div id="debug"></div>

  <script>
    const statusDiv = document.getElementById('status');
    const messagesDiv = document.getElementById('messages');
    const debugDiv = document.getElementById('debug');

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
      debugDiv.innerHTML += `<p style="color: ${color};">[${timestamp}] ${message}</p>`;
      console.log(`[${timestamp}] ${message}`);
    }

    // Try both polling and websocket
    const socket = io('http://localhost:3000', {
      transports: ['polling', 'websocket'], // Allow both transports
      timeout: 10000,
      forceNew: true,
    });

    addLog('Attempting to connect to http://localhost:3000');

    socket.on('connect', () => {
      addLog('✅ Connected to NestJS!', 'success');
      statusDiv.textContent = 'Connected!';
      statusDiv.style.color = 'green';
      
      addLog(`Socket ID: ${socket.id}`);
      addLog(`Transport: ${socket.io.engine.transport.name}`);
      
      // Send initial message
      socket.emit('createNotification', 'Hello from browser!');
      addLog('📤 Sent initial message');
    });

    socket.on('newNotification', data => {
      addLog(`📨 Server response: ${data}`, 'success');
      messagesDiv.innerHTML += `<p style="background: #e8f5e8; padding: 10px; margin: 5px 0;">Server: ${data}</p>`;
    });

    socket.on('disconnect', (reason) => {
      addLog(`❌ Disconnected: ${reason}`, 'error');
      statusDiv.textContent = `Disconnected: ${reason}`;
      statusDiv.style.color = 'red';
    });

    socket.on('connect_error', err => {
      addLog(`🔥 Connect Error: ${err.message}`, 'error');
      statusDiv.textContent = `Connection Error: ${err.message}`;
      statusDiv.style.color = 'red';
    });

    // Log transport upgrade
    socket.io.on("upgrade", () => {
      addLog(`⬆️ Upgraded to transport: ${socket.io.engine.transport.name}`);
    });

    function sendMessage() {
      const message = `Test message at ${new Date().toLocaleTimeString()}`;
      socket.emit('createNotification', message);
      addLog(`📤 Sent: ${message}`);
    }

    // Test connection after page load
    window.addEventListener('load', () => {
      addLog('Page loaded, socket connecting...');
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #debug { 
      background: #f5f5f5; 
      padding: 10px; 
      margin-top: 20px; 
      max-height: 300px; 
      overflow-y: auto; 
      font-size: 12px;
    }
    button { 
      padding: 10px 20px; 
      margin: 10px 0; 
      font-size: 16px; 
      cursor: pointer; 
    }
    #status { 
      font-weight: bold; 
      font-size: 18px; 
      margin: 10px 0; 
    }
  </style>
</body>
</html>